<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>社会体育館 行事予定カレンダー</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #f7f7f7;
  }

  h1 {
    text-align: center;
    padding: 16px;
    margin: 0;
    background: #4a6fa5;
    color: white;
    font-size: 20px;
  }

  .tabs {
    display: flex;
    gap: 8px;
    padding: 12px;
    overflow-x: auto;
    background: white;
    border-bottom: 1px solid #ddd;
  }

  .tab {
    padding: 8px 14px;
    border-radius: 20px;
    background: #e0e0e0;
    cursor: pointer;
    white-space: nowrap;
    font-size: 14px;
    border: 1px solid #ccc;
    transition: 0.2s;
  }

  .tab:hover {
    background: #d5d5d5;
  }

  .tab.active {
    background: #4a6fa5;
    color: white;
    border-color: #4a6fa5;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    background: white;
    table-layout: fixed;
  }

  /* 列幅（PC：夜間削除 → 午後を広く） */
  th:nth-child(1), td:nth-child(1) { width: 10%; }  /* 日付 */
  th:nth-child(2), td:nth-child(2) { width: 30%; }  /* 午前 */
  th:nth-child(3), td:nth-child(3) { width: 60%; }  /* 午後（夜間統合） */

  th, td {
    border: 1px solid #ddd;
    padding: 4px 6px;
    font-size: 12px;
    vertical-align: middle;
    height: 48px;
    line-height: 1.2;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  th {
    background: #f0f0f0;
  }

  /* 土日背景色 */
  .saturday { background: #e3f2fd; }
  .sunday   { background: #ffebee; }

  /* 祝日背景色 */
  .holiday  { background: #fff8e1; }

  /* 今日の行ハイライト */
  tr.today-row {
    outline: 2px solid #ff9800;
    outline-offset: -2px;
    background: #fff3e0 !important;
  }

  /* 日付セル（2段構成） */
  .date-cell {
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 100%;
    line-height: 1.1;
    white-space: nowrap;
    overflow: hidden;
  }

  .date-top {
    font-size: 12px;
    font-weight: 500;
  }

  .date-bottom {
    font-size: 8px;
    color: #d32f2f;
    margin-top: 2px;
  }

  /* 曜日バッジ */
  .weekday-badge {
    display: inline-block;
    padding: 1px 4px;
    margin-left: 3px;
    border-radius: 8px;
    font-size: 9px;
    color: #fff;
  }

  .w-sun { background: #e57373; }
  .w-mon { background: #64b5f6; }
  .w-tue { background: #4db6ac; }
  .w-wed { background: #9575cd; }
  .w-thu { background: #ffb74d; }
  .w-fri { background: #4fc3f7; }
  .w-sat { background: #7986cb; }

  /* イベント2段レイアウト */
  .event-box {
    display: flex;
    flex-wrap: wrap;
    gap: 2px 4px;
    height: 100%;
    align-content: flex-start;
  }

  .event {
    padding: 1px 4px;
    border-radius: 4px;
    color: #fff;
    font-size: 11px;
    line-height: 1.1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    position: relative;
  }

  /* 色分け */
  .color-badminton { background: #4caf50; }
  .color-tabletennis { background: #2196f3; }
  .color-volleyball { background: #ff9800; }
  .color-kids { background: #9c27b0; }
  .color-default { background: #607d8b; }

  /* PC: イベント名ホバーで全文表示 */
  @media (min-width: 601px) {
    .event:hover::after {
      content: attr(data-fulltext);
      position: absolute;
      left: 0;
      top: 100%;
      white-space: nowrap;
      background: #333;
      color: #fff;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 10;
    }
  }

  /* スマホ最適化 */
@media (max-width: 600px) {

  h1 {
    font-size: 17px;
    padding: 10px;
  }

  .tab {
    font-size: 13px;
    padding: 6px 10px;
  }

  /* ★ セルの高さを詰める（ここが重要） */
  th, td {
    font-size: 11px;
    padding: 2px 3px;     /* ← 余白を減らす */
    height: 34px;         /* ← 高さを詰める（44px → 34px） */
    line-height: 1.15;    /* ← 行間を少し詰める */
  }

  /* 列幅（スマホ） */
  th:nth-child(1), td:nth-child(1) { width: 15%; }
  th:nth-child(2), td:nth-child(2) { width: 30%; }
  th:nth-child(3), td:nth-child(3) { width: 55%; }

  .date-top {
    font-size: 13px;
  }

  .date-bottom {
    font-size: 8px;
  }

  /* イベント（スマホ） */
  .event {
    font-size: 11px;
    max-width: 100%;
    line-height: 1.15;    /* ← 行間を詰める */
    padding: 1px 4px;     /* ← 余白を減らす */
    border-radius: 4px;
    opacity: 0.85;        /* ← 背景色を淡く */
  }

  .event-box {
    gap: 1px 3px;         /* ← イベント同士の隙間も少し詰める */
  }
}

  /* 印刷用（A4横） */
  @media print {

    @page {
      size: A4 landscape;
      margin: 10mm;
    }

    body {
      background: white;
    }

    h1, .tabs {
      display: none;
    }

    table {
      font-size: 11px;
      border: 1px solid #000;
    }

    th, td {
      border: 1px solid #000;
      height: 32px;
      white-space: nowrap;
    }

    .event {
      font-size: 10px;
    }

    tr.today-row {
      outline: none;
      background: #fff3c4 !important;
    }
  }
</style>
</head>

<body>

<h1>社会体育館 行事予定カレンダー</h1>

<div class="tabs" id="monthTabs"></div>

<div id="calendarContainer">
  <div class="loading">読み込み中...</div>
</div>
<script>
const CALENDAR_ID =
  "c15c3451e52f787202dca97fbd0e35c908d5972611deb534d78c8f6b46262895@group.calendar.google.com";

const HOLIDAY_CALENDAR_ID =
  "japanese__ja@holiday.calendar.google.com";

const API_KEY = "AIzaSyDZwpeUR_Vx_0D88WlRfSqJsRsf4WE_oyw"; // ← 実際のAPIキーに差し替え

const WEEKDAYS = ["日", "月", "火", "水", "木", "金", "土"];

const today = new Date();
const todayStr = today.toISOString().split("T")[0];

const months = [];
for (let i = -1; i <= 3; i++) {
  const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
  months.push({
    label: `${d.getFullYear()}年${d.getMonth() + 1}月`,
    year: d.getFullYear(),
    month: d.getMonth()
  });
}

const tabArea = document.getElementById("monthTabs");
months.forEach((m, idx) => {
  const tab = document.createElement("div");
  tab.className = "tab" + (idx === 1 ? " active" : "");
  tab.textContent = m.label;
  tab.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    loadMonth(m.year, m.month);
  };
  tabArea.appendChild(tab);
});

async function fetchEvents(calendarId, year, month) {
  const start = new Date(year, month, 1).toISOString();
  const end = new Date(year, month + 1, 1).toISOString();

  const url =
    `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events` +
    `?key=${API_KEY}&timeMin=${start}&timeMax=${end}` +
    `&singleEvents=true&orderBy=startTime`;

  const res = await fetch(url);
  const data = await res.json();
  return data.items || [];
}
function classifyTime(ev) {
  if (!ev.start.dateTime) return "その他";
  const hour = new Date(ev.start.dateTime).getHours();
  if (hour < 12) return "午前";
  if (hour < 18) return "午後";
  return "夜間";  // ← 午後セルに統合するが分類は残す
}

function detectColor(title) {
  if (title.includes("バド")) return "color-badminton";
  if (title.includes("卓球")) return "color-tabletennis";
  if (title.includes("バレー")) return "color-volleyball";
  if (title.includes("キッズ")) return "color-kids";
  return "color-default";
}

function renderTable(events, holidayMap, year, month) {
  const container = document.getElementById("calendarContainer");
  container.innerHTML = "";

  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>日付</th>
      <th>午前</th>
      <th>午後</th>
    </tr>
  `;

  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for (let day = 1; day <= daysInMonth; day++) {
    const dateObj = new Date(year, month, day);
    const weekday = WEEKDAYS[dateObj.getDay()];
    const dateStr =
      `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

    const dayEvents = events.filter(ev => {
      const d = ev.start.date || ev.start.dateTime.split("T")[0];
      return d === dateStr;
    });

    // 午前・午後・夜間の3分類（夜間は午後に統合する）
    const slots = { "午前": [], "午後": [], "夜間": [] };

    dayEvents.forEach(ev => {
      const time = classifyTime(ev);
      const color = detectColor(ev.summary || "");
      const title = ev.summary || "";

      const start = ev.start.dateTime ? new Date(ev.start.dateTime) : null;
      const end   = ev.end.dateTime   ? new Date(ev.end.dateTime)   : null;

      const format = d =>
        String(d.getHours()).padStart(2, "0") + ":" +
        String(d.getMinutes()).padStart(2, "0");

      let timeLabel = "";
      if (start && end) {
        timeLabel = `${format(start)}–${format(end)}`;
      }

      const displayText = timeLabel ? `${timeLabel} ${title}` : title;

      slots[time].push({
        start: start,
        html: `<div class="event ${color}" data-fulltext="${displayText}">${displayText}</div>`
      });
    });

    // 時刻順に並べ替え
    slots["午前"].sort((a, b) => a.start - b.start);
    slots["午後"].sort((a, b) => a.start - b.start);
    slots["夜間"].sort((a, b) => a.start - b.start);

// 午後セル（午後＋夜間をまとめて1段）
const afternoonHTML = `
  <div class="event-box">
    ${[...slots["午後"], ...slots["夜間"]]
      .sort((a, b) => a.start - b.start)
      .map(e => e.html)
      .join("")}
  </div>
`;

    const weekdayClass = {
      "日": "w-sun",
      "月": "w-mon",
      "火": "w-tue",
      "水": "w-wed",
      "木": "w-thu",
      "金": "w-fri",
      "土": "w-sat"
    }[weekday];

    const dateCell = `
      <div class="date-cell">
        <div class="date-top">
          ${day}
          <span class="weekday-badge ${weekdayClass}">${weekday}</span>
        </div>
        <div class="date-bottom">${holidayMap[dateStr] || ""}</div>
      </div>
    `;

    let rowClass = "";
    if (holidayMap[dateStr]) {
      rowClass = "holiday";
    } else if (weekday === "日") {
      rowClass = "sunday";
    } else if (weekday === "土") {
      rowClass = "saturday";
    }

    const isToday = (dateStr === todayStr);

    const tr = document.createElement("tr");
    tr.className = rowClass + (isToday ? " today-row" : "");
    tr.innerHTML = `
      <td>${dateCell}</td>
      <td><div class="event-box">${slots["午前"].map(e => e.html).join("")}</div></td>
      <td>${afternoonHTML}</td>
    `;
    table.appendChild(tr);
  }

  container.appendChild(table);
}

async function loadMonth(year, month) {
  const container = document.getElementById("calendarContainer");
  container.innerHTML = `<div class="loading">読み込み中...</div>`;

  const events = await fetchEvents(CALENDAR_ID, year, month);
  const holidayEvents = await fetchEvents(HOLIDAY_CALENDAR_ID, year, month);

  const holidayMap = {};
  holidayEvents.forEach(ev => {
    const date = ev.start.date || ev.start.dateTime.split("T")[0];
    holidayMap[date] = ev.summary;
  });

  renderTable(events, holidayMap, year, month);
}

loadMonth(today.getFullYear(), today.getMonth());
</script>

</body>
</html>
