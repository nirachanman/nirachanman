<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼byå·å£å…¬æ°‘é¤¨</title>

<style>
:root {
  --color-primary: #4a6fa5;
  --color-bg: #f3f4f6;
  --color-white: #ffffff;
  --color-border: #999;

  --cal1-color: #4a6fa5;
  --cal2-color: #0d8a6a;
  --cal3-color: #b06f07;
  --calAll-color: #6b7280;

  --radius-pill: 30px;
  --shadow: 0 2px 4px rgba(0,0,0,0.15);
}

* { -webkit-tap-highlight-color: transparent; }

html { scrollbar-gutter: stable; }

body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 0;
  background: var(--color-bg);
  transition: background 0.5s ease;
}

/* èƒŒæ™¯ */
body.bg-gym       { background: linear-gradient(135deg, #eef7f1, #d7ead9); }
body.bg-kouminkan { background: linear-gradient(135deg, #eef3ff, #d6e3fb); }
body.bg-bekkan    { background: linear-gradient(135deg, #fff8ec, #ffe8c7); }
body.bg-all       { background: linear-gradient(135deg, #f2f2f2, #e0e0e0); }

/* Top Bar */
.top-bar {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  background: var(--color-white);
  border-bottom: 1px solid var(--color-border);
  overflow-x: auto;
  position: static;
  top: 0;
  z-index: 1000;
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.top-bar::-webkit-scrollbar { display: none; }

/* Google Calendar Button */
.google-cal-btn {
  display: inline-flex;
  flex-shrink: 0;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: #4285f4;
  color: #fff;
  text-decoration: none;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-left: auto;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.google-cal-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(66,133,244,0.5);
}
.google-cal-icon  { font-size: 16px; line-height: 1; }
.google-cal-label { white-space: nowrap; }

/* Facility Buttons */
.calendar-buttons {
  display: flex;
  gap: 20px;
  flex-wrap: nowrap;
  margin-left: 10px;
}
.calendar-buttons button {
  padding: 4px 14px;
  flex-shrink: 0;
  border-radius: 9999px;
  border: 2px solid rgba(255,255,255,0.7);
  background: white;
  cursor: pointer;
  font-size: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-width: 140px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: all 0.25s ease;
  position: relative;
  overflow: visible;
}
.calendar-buttons button.active::before {
  content: "";
  position: absolute;
  inset: -5px;
  border-radius: 9999px;
  background: radial-gradient(circle,
    rgba(255,255,255,0.9) 0%,
    rgba(255,255,255,0.4) 40%,
    rgba(255,255,255,0) 70%
  );
  box-shadow: 0 0 16px rgba(255,255,255,0.9);
  opacity: 1;
  transition: opacity 0.4s ease;
  z-index: -1;
}
.calendar-buttons button::before { opacity: 0; }
.calendar-buttons button.active {
  transform: translateY(-3px) scale(1.06);
  box-shadow: 0 8px 18px rgba(0,0,0,0.25);
  border-color: rgba(255,255,255,1);
  background: rgba(255,255,255,0.98);
}
.calendar-buttons button:hover:not(.active) {
  background: #fff;
  transform: scale(1.15);
  box-shadow: 0 0 12px rgba(66,133,244,0.7);
  border-color: rgba(255,255,255,1);
}
#btn-kouminkan.active { background: #c4d7ff; color: #0a3a8c; }
#btn-gym.active       { background: #bfe8cf; color: #0a5222; }
#btn-bekkan.active    { background: #ffe0a8; color: #7a4f00; }
#btn-all.active       { background: #d0d0d0; color: #222; }

@media (max-width: 600px) {
  .calendar-buttons button.active { transform: none !important; }
  .calendar-buttons { gap: 6px; }
  .calendar-buttons button {
    font-size: 14px;
    padding: 6px 6px;
    min-width: 80px;
    gap: 4px;
    border-width: 1px;
    border-radius: 20px;
  }
}

/* Fixed Header */
.header-fixed {
  position: sticky;
  top: 0;
  z-index: 2000;
  background: var(--color-white);
  border-bottom: 1px solid var(--color-border);
}

/* Month Tabs */
.tabs {
  display: flex;
  gap: 4px;
  padding: 4px 6px;
  overflow-x: auto;
  background: var(--color-white);
  border-bottom: 1px solid var(--color-border);
  position: static;
  z-index: 999;
}
.tab {
  padding: 4px 8px;
  border-radius: 9999px;
  background: white;
  border: 2px solid rgba(255,255,255,0.7);
  cursor: pointer;
  white-space: nowrap;
  font-size: 12px;
  font-weight: 600;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: all 0.35s cubic-bezier(.25,.8,.25,1);
  position: relative;
  overflow: visible;
}
.tab.active {
  background: var(--color-primary);
  color: #fff;
  box-shadow: none;
  transform: none;
  border-color: rgba(255,255,255,1);
}
.tab::before { opacity: 0; }
.tab.active {
  box-shadow: 0 8px 18px rgba(0,0,0,0.25);
  border-color: rgba(255,255,255,1);
  background: var(--color-primary);
  color: #7fff00;
  font-weight: 600;
/* transform: translateY(-2px); â† å‰Šé™¤ */
}
@media (max-width: 500px) {
  .tab {
    padding: 2px 6px;
    font-size: 10px;
    max-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    direction: rtl;
    text-align: left;
  }
}

/* Calendar Area */
.calendar-wrapper { padding: 5px; }
.calendar-box {
  background: var(--color-primary);
  border-radius: 5px;
  box-shadow: var(--shadow);
  padding: 2px;
  margin: 6px auto;
  max-width: 1200px;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--color-white);
  table-layout: fixed;
}
th, td {
  width: auto;
  border: 1px solid var(--color-border);
  padding: 4px 6px;
  font-size: 12px;
  line-height: 1.2;
}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆçµ±ä¸€ */
.calendar-table, 
.calendar-table th, 
.calendar-table td {
  font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;
}
.calendar-table td {
  font-weight: 500;
}

/* Date Cells */
th:nth-child(1), td:nth-child(1) { width: 12% !important; }
th:nth-child(2), td:nth-child(2) { width: 35% !important; }
th:nth-child(3), td:nth-child(3) { width: 53% !important; }
@media (max-width: 600px) {
  th:nth-child(1), td:nth-child(1) { width: 20% !important; }
}
.date-cell {
  text-align: right;
  font-weight: 600;
  font-size: 18px;
}
/* .day-number {
  font-family: "Roboto Mono", "Courier New", monospace;
} */

.today-highlight td {
  background: #fef9c3 !important;
  border-color: #facc15 !important;
}

/* Holiday Label */
.holiday-name {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 16px;
  padding: 1px 4px;
  background: #fca5a5;
  color: #7f1d1d;
  font-size: 8px;
  font-weight: 400;
  border-radius: 6px;
  margin-top: 2px;
  line-height: 1;
}

/* Weekday Colors */
.weekday-sun     { color: #e11d48 !important; }
.weekday-sat     { color: #2563eb !important; }
.weekday-holiday { color: #d97706 !important; }

/* Row Backgrounds */
.row-sun     { background: #fff1f2 !important; }
.row-sat     { background: #eff6ff !important; }
.row-holiday { background: #fff7ed !important; }

/* Events */
.event-box {
  display: flex;
  flex-wrap: wrap;
  gap: 2px 4px;
  cursor: default; /* ã¾ãŸã¯å‰Šé™¤ */
}
.event-box:hover {
  opacity: 0.9;
  transition: opacity 0.2s ease;
}
.event {
  padding: 2px 6px;
  border-radius: 6px;
  color: #fff;
  font-size: 14px;
  font-weight: 400 !important;
  cursor: pointer;
}
.event:hover {
  opacity: 0.9;
}
.event-title { position: relative; }

/* Tooltipï¼ˆä¿æŒç”¨ï¼‰ */
.tooltip {
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translate(-50%, -100%);
  background: rgba(255,255,255,0.95);
  color: #333;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 12px;
  line-height: 1.3;
  width: 260px;
  text-align: left;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.35);
  border: 1px solid rgba(0,0,0,0.1);
  pointer-events: none;
  display: none;
}
.tooltip-line {
  display: flex;
  gap: 6px;
  align-items: flex-start;
  line-height: 1.3;
}
.tooltip-line::before {
  content: "â€¢";
  color: #555;
  font-size: 14px;
  line-height: 1.3;
}
.event-title.facility-k .tooltip {
  background: #e8f0ff !important;
  color: #000 !important;
  border: 1px solid rgba(0,0,0,0.15);
}
.event-title.facility-t .tooltip {
  background: #e6f7ef !important;
  color: #000 !important;
  border: 1px solid rgba(0,0,0,0.15);
}
.event-title.facility-b .tooltip {
  background: #fff4e0 !important;
  color: #000 !important;
  border: 1px solid rgba(0,0,0,0.15);
}
.event time,
.event-time {
  color: #ffff22 !important;
  font-weight: 500;
}

/* PC / SP Switch */
.pc-only { display: table-cell; }
.sp-only { display: none; }
@media (max-width: 600px) {
  .pc-only { display: none !important; }
  .sp-only { display: table-cell !important; }
}

.reload-btn {
  padding: 6px 10px;
  background: var(--color-primary);
  color: #fff;
  border: none;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  cursor: pointer;
}

.reload-btn:active {
  transform: scale(0.95);
}

/* PC Event Layout */
@media (min-width: 769px) {
  .event {
    display: inline-flex !important;
    flex-direction: row !important;
    align-items: center;
    gap: 4px;
  }
  .event-time {
    margin-right: 4px;
    font-size: 12px;
    color: #ffeb3b !important;
  }
  .event-title {
    font-size: 12px;
    font-weight: 400;
  }
}

/* Smartphone Month Tabs */
@media (max-width: 600px) {
  .tabs {
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 4px;
  }
  .tab {
    font-size: 11px;
    padding: 3px 10px;
    min-width: 60px;
    margin-right: 8px;
  }
}

/* Hide Google Calendar on SP */
@media (max-width: 600px) {
  .google-cal-btn,
  .google-cal-wrapper,
  .google-cal-label {
    display: none !important;
  }
}

/* Disable hover tooltip on touch devices */
@media (hover: none) {
  .event-title:hover .tooltip { display: none; }
}

/* Print Styles */
#print-header { display: none; }

@media print {
  #print-header { display: none; }

  @media print {
    .top-bar,
    .tabs,
    .header-fixed {
      display: none !important;
    }
  }

  @media print {
    #print-header {
      display: block;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      padding: 6px 0;
      text-align: center;
      border-bottom: 2px solid #000;
    }
  }

  * {
    color: #000 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .weekday-sun,
  .weekday-sat,
  .weekday-holiday {
    color: #000 !important;
  }

  .row-sun     { background: #fff1f2 !important; }
  .row-sat     { background: #eff6ff !important; }
  .row-holiday { background: #fff7ed !important; }

  .event,
  .holiday-name,
  .calendar-box,
  table,
  th,
  td {
    background: #fff !important;
  }

  tr.row-sun td     { background: #fff1f2 !important; }
  tr.row-sat td     { background: #eff6ff !important; }
  tr.row-holiday td { background: #fff7ed !important; }

  .today-highlight td {
    background: #fff !important;
    border-color: #999 !important;
  }

  .event-time { color: #000 !important; }

  .tab,
  .calendar-buttons button {
    color: #000 !important;
    background: #fff !important;
    box-shadow: none !important;
    border: 1px solid #000 !important;
    transform: none !important;
  }

  .calendar-buttons button::before { display: none !important; }

  .tooltip {
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translate(-50%, -100%);
    background: rgba(0,0,0,0.9);
    color: #fff;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.6;
    width: 360px;
    text-align: left;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    pointer-events: none;
    display: none;
  }
  .event-title:hover .tooltip { display: block; }
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯è©³ç´°è¡¨ç¤ºï¼‰ */
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.35);
}
.modal-content {
  background: #f6fff6;
  margin: 60px auto;
  padding: 8px 10px;
  border-radius: 12px;
  width: 85%;
  max-width: 300px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  font-size: 14px;
  border-top: 6px solid #28a745;
}

/* å…¬æ°‘é¤¨ï¼ˆé’ï¼‰ */
.modal-content.k {
  background: #e8f0ff;   /* æ·¡ã„é’ */
  border-top: 6px solid #4a7bd1;
}
.modal-content.k h3,
.modal-content.k .modal-info-title {
  color: #0a3a8c;
}

/* ä½“è‚²é¤¨ï¼ˆç·‘ï¼‰ */
.modal-content.t {
  background: #e6f7ef;   /* æ·¡ã„ç·‘ */
  border-top: 6px solid #3aa86b;
}
.modal-content.t h3,
.modal-content.t .modal-info-title {
  color: #0a5222;
}

/* åˆ¥é¤¨ï¼ˆæ©™ï¼‰ */
.modal-content.b {
  background: #fff4e0;   /* æ·¡ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
  border-top: 6px solid #e08a2e;
}
.modal-content.b h3,
.modal-content.b .modal-info-title {
  color: #7a4f00;
}

/* å…¬æ°‘é¤¨ï¼ˆé’ï¼‰ */
.modal-content.k .modal-info-box {
  border-color: #4a7bd1;
}

/* ä½“è‚²é¤¨ï¼ˆç·‘ï¼‰ */
.modal-content.t .modal-info-box {
  border-color: #3aa86b;
}

/* åˆ¥é¤¨ï¼ˆæ©™ï¼‰ */
.modal-content.b .modal-info-box {
  border-color: #e08a2e;
}

.modal-content h3 {
  margin-top: 0;
  margin-bottom: 10px;
  color: #28a745;
  font-size: 22px;   /* â† è¦‹å‡ºã— */
  font-weight: bold;
  text-align: center;
}
.modal-info-box {
  border: 1px solid #c8e6c9;
  background: #ffffff;
  padding: 8px 10px;
  border-radius: 6px;
  margin: 8px 0;
  font-size: 18px;   /* â† æœ¬æ–‡ã®ã‚µã‚¤ã‚º */
  line-height: 1.4;
}
.modal-info-title {
  font-weight: bold;
  color: #28a745;
  margin-bottom: 4px;
  font-size: 18px;   /* â† è¦‹å‡ºã— */
}
.modal-close {
  float: right;
  font-size: 30px;
  cursor: pointer;
  color: #444;
  margin-top: -4px;
}
.modal-close:hover { color: #d9534f; }
#modal-body p {
  margin: 6px 0;
  line-height: 1.4;
}

@media (max-width: 600px) {
  .modal-content {
    font-size: 22px !important;   /* â† é‡è¦ */
  }
  .modal-info-box {
    font-size: 22px !important;   /* â† æœ¬æ–‡ã®ã‚µã‚¤ã‚º */
  }
  .modal-info-title {
    font-size: 18px !important;   /* â† è¦‹å‡ºã— */
  }
  #modal-body {
    font-size: 22px !important;   /* â† èª¬æ˜æ–‡ */
  }
  .modal-content .modal-info-box {
    padding: 4px 6px !important;   /* â† ã“ã“ãŒç¢ºå®Ÿã«åŠ¹ã */
  }
}

</style>
</head>

<body>
<div id="print-header"></div>

<div class="header-fixed">
  <div class="top-bar">
    <div class="calendar-buttons">
      <button id="btn-kouminkan" data-cal="1" class="active">ğŸ¬ å…¬æ°‘é¤¨</button>
      <button id="btn-gym" data-cal="2">ğŸƒ ä½“è‚²é¤¨</button> 
      <button id="btn-bekkan" data-cal="3">ğŸ“š åˆ¥é¤¨</button>
      <button id="btn-all" data-cal="all">ğŸ”˜ å…¨æ–½è¨­</button>
    </div>
    <button id="reload-btn" class="sp-only reload-btn">ğŸ”„</button>
    <a href="https://calendar.google.com/" target="_blank" class="google-cal-btn">
      <span class="google-cal-icon">ğŸ“…</span>
      <span class="google-cal-label">Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ç·¨é›†</span>
    </a>
  </div>

  <div class="tabs" id="monthTabs"></div>
</div>

<div id="calendarContainer" class="calendar-wrapper">
  <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="popup" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closePopup()">âœ•</span>
    <div id="modal-body"></div>
  </div>
</div>

<script>
console.log("JSå‹•ã„ã¦ã‚‹ã‚ˆ");

let CURRENT_CALENDAR = 1;

const CALENDAR_IDS = {
  1: "31492fb4b39fef411514fef1378eaf68f176de53432052015b21a14223757e1d@group.calendar.google.com",
  2: "c15c3451e52f787202dca97fbd0e35c908d5972611deb534d78c8f6b46262895@group.calendar.google.com",
  3: "kawaguchi.public.hall.annex@gmail.com"
};

const CALENDAR_NAMES = {
  1: "å…¬æ°‘é¤¨",
  2: "ä½“è‚²é¤¨",
  3: "åˆ¥é¤¨"
};

const CALENDAR_COLORS = {
  1: "var(--cal1-color)",
  2: "var(--cal2-color)",
  3: "var(--cal3-color)",
  all: "var(--calAll-color)"
};

const FACILITY_COLOR = {
  "å…¬æ°‘é¤¨": "var(--cal1-color)",
  "ä½“è‚²é¤¨": "var(--cal2-color)",
  "åˆ¥é¤¨": "var(--cal3-color)"
};

const HOLIDAY_CALENDAR_ID = "japanese__ja@holiday.calendar.google.com";
const API_KEY = "AIzaSyA5YSgL1PG9e61Nk7b-SbPV99XMvHeGGtI";

const WEEKDAYS = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
const today = new Date();

/* å°åˆ·ã‚¿ã‚¤ãƒˆãƒ« */
function updatePrintHeader() {
  const facility =
    CURRENT_CALENDAR === "all"
      ? "å…¨æ–½è¨­"
      : CALENDAR_NAMES[CURRENT_CALENDAR];

  const activeTab = document.querySelector("#monthTabs .active");
  const monthLabel = activeTab ? activeTab.textContent : "";

  document.getElementById("print-header").textContent =
    `${facility}ã€€${monthLabel}`;
}

/* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è‰² */
function getKeywordColor(title) {
  const KEYWORD_COLORS = [
    { keywords: ["ä»®ï¼‰"], color: "#a9a9a9" },
    { keywords: ["ï½·ï½¬ï¾ï½¾ï¾™", "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", "ä¸­æ­¢"], color: "#dc2626" },
    { keywords: ["1f", "å›²ç¢éƒ¨", "ç¿’å­—", "è‹¥å¦»ä¼š"], color: "#4a6fa5" },
    { keywords: ["2fs", "PC", "ã‚­ãƒ«ãƒˆ", "è‹±èª"], color: "#4a6fa5" },
    { keywords: ["2f", "ãƒ¨ã‚¬", "ä½“æ“", "æ´‹å“åº—"], color: "#4a6fa5" }
  ];
  for (const rule of KEYWORD_COLORS) {
    for (const kw of rule.keywords) {
      if (title.includes(kw)) return rule.color;
    }
  }
  return null;
}

/* ã‚¤ãƒ™ãƒ³ãƒˆ HTML */
function createEventHTML(ev, baseColor) {
  const title = ev.summary || "";
  const keywordColor = getKeywordColor(title);
  const color = keywordColor || baseColor;

  const start = ev.start.dateTime ? new Date(ev.start.dateTime) : null;
  const end   = ev.end.dateTime   ? new Date(ev.end.dateTime)   : null;

  const timeLabel = (start && end)
    ? `${String(start.getHours()).padStart(2,"0")}:${String(start.getMinutes()).padStart(2,"0")}â€“${String(end.getHours()).padStart(2,"0")}:${String(end.getMinutes()).padStart(2,"0")}`
    : "";

  const facilityClass =
    ev._facility === "å…¬æ°‘é¤¨" ? "facility-k" :
    ev._facility === "ä½“è‚²é¤¨"   ? "facility-t" :
    ev._facility === "åˆ¥é¤¨"   ? "facility-b" :
    "facility-default";

  const detailLines = (ev.description || "")
    .split("\n")
    .map(line => `<div class="tooltip-line">${line}</div>`)
    .join("");

  /* â˜…â˜…â˜… ã“ã“ã§ data-date ã‚’è¿½åŠ  â˜…â˜…â˜… */
  const dateRaw = ev.start.date || (ev.start.dateTime ? ev.start.dateTime.split("T")[0] : "");

  return `
    <div class="event" style="background:${color}"
         data-date="${dateRaw}"
         data-location="${ev.location ? ev.location.replace(/"/g, '&quot;') : ''}">
      <div class="event-time">${timeLabel}</div>
      <div class="event-title ${facilityClass}">
        ${title}
        <div class="tooltip">${detailLines}</div>
      </div>
    </div>
  `;
}

/* Google Calendar API */
async function fetchEvents(calendarId, year, month) {
  const start = new Date(year, month, 1).toISOString();
  const end = new Date(year, month + 1, 1).toISOString();
  const url =
    `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events` +
    `?key=${API_KEY}&timeMin=${start}&timeMax=${end}` +
    `&singleEvents=true&orderBy=startTime`;

  const res = await fetch(url);
  const data = await res.json();
  return data.items || [];
}

function classifyTime(ev) {
  if (!ev.start.dateTime) return "åˆå‰";
  return new Date(ev.start.dateTime).getHours() < 12 ? "åˆå‰" : "åˆå¾Œ";
}

/* ç¥æ—¥ */
function createHolidayMap(holidayEvents) {
  const map = {};
  holidayEvents.forEach(ev => {
    const date = ev.start.date || (ev.start.dateTime ? ev.start.dateTime.split("T")[0] : "");
    map[date] = ev.summary;
  });
  return map;
}

function getWeekdayClass(dateObj, holidayMap, dateStr) {
  if (holidayMap[dateStr]) return "weekday-holiday";
  const w = dateObj.getDay();
  if (w === 0) return "weekday-sun";
  if (w === 6) return "weekday-sat";
  return "";
}

function getRowClass(dateObj, holidayMap, dateStr) {
  if (holidayMap[dateStr]) return "row-holiday";
  const w = dateObj.getDay();
  if (w === 0) return "row-sun";
  if (w === 6) return "row-sat";
  return "";
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«æç”» */
function renderTable(events, holidayMap, year, month, title, themeColor) {
  const box = document.createElement("div");
  box.className = "calendar-box";

  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>${title}</th>
      <th class="pc-only">åˆå‰</th>
      <th class="pc-only">åˆå¾Œ</th>
      <th class="sp-only">ã‚¤ãƒ™ãƒ³ãƒˆ</th>
    </tr>
  `;

  const days = new Date(year, month + 1, 0).getDate();

  for (let day = 1; day <= days; day++) {
    const dateObj = new Date(year, month, day);
    const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    const weekday = WEEKDAYS[dateObj.getDay()];

    const dayEvents = events.filter(ev => {
      const d = ev.start.date || (ev.start.dateTime ? ev.start.dateTime.split("T")[0] : "");
      return d === dateStr;
    });

    const slots = { "åˆå‰": [], "åˆå¾Œ": [] };

    dayEvents.forEach(ev => {
      const time = classifyTime(ev);
      const color = ev._facility ? FACILITY_COLOR[ev._facility] : themeColor;
      slots[time].push({
        start: ev.start.dateTime ? new Date(ev.start.dateTime) : null,
        html: createEventHTML(ev, color)
      });
    });

    slots["åˆå‰"].sort((a,b)=> (a.start || 0) - (b.start || 0));
    slots["åˆå¾Œ"].sort((a,b)=> (a.start || 0) - (b.start || 0));

    const merged = [...slots["åˆå‰"], ...slots["åˆå¾Œ"]];

    const holidayName = holidayMap[dateStr]
      ? `<div class="holiday-name">${holidayMap[dateStr]}</div>`
      : "";

    const weekdayClass = getWeekdayClass(dateObj, holidayMap, dateStr);
    const rowClass = getRowClass(dateObj, holidayMap, dateStr);

    const tr = document.createElement("tr");
    tr.className = rowClass;

    if (
      dateObj.getFullYear() === today.getFullYear() &&
      dateObj.getMonth() === today.getMonth() &&
      dateObj.getDate() === today.getDate()
    ) {
      tr.classList.add("today-highlight");
    }

    tr.innerHTML = `
      <td>
        <div class="date-cell">
          <span class="day-number ${weekdayClass}">${day}</span>
          <span class="${weekdayClass}">(${weekday})</span>
        </div>
      </td>

      <td class="pc-only">
        <div class="event-box">
          ${holidayName}
          ${slots["åˆå‰"].map(e=>e.html).join("")}
        </div>
      </td>

      <td class="pc-only">
        <div class="event-box">
          ${slots["åˆå¾Œ"].map(e=>e.html).join("")}
        </div>
      </td>

      <td class="sp-only">
        <div class="event-box">
          ${holidayName}
          ${merged.map(e=>e.html).join("")}
        </div>
      </td>
    `;

    table.appendChild(tr);
  }

  box.appendChild(table);
  return box;
}

/* æœˆèª­ã¿è¾¼ã¿ï¼ˆçµ±åˆç‰ˆï¼‰ */
async function loadMonth(year, month) {
  const container = document.getElementById("calendarContainer");
  container.innerHTML = `<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>`;

  if (CURRENT_CALENDAR === "all") {
    const allEvents = [];
    for (let c = 1; c <= 3; c++) {
      const evs = await fetchEvents(CALENDAR_IDS[c], year, month);
      evs.forEach(ev => {
        ev._facility = CALENDAR_NAMES[c];
        allEvents.push(ev);
      });
    }

    const holidayEvents = await fetchEvents(HOLIDAY_CALENDAR_ID, year, month);
    const holidayMap = createHolidayMap(holidayEvents);

    container.innerHTML = "";
    container.appendChild(
      renderTable(allEvents, holidayMap, year, month, "å…¨æ–½è¨­çµ±åˆ", CALENDAR_COLORS.all)
    );

    updatePrintHeader();
    return;
  }

  const events = await fetchEvents(CALENDAR_IDS[CURRENT_CALENDAR], year, month);
  events.forEach(ev => {
    ev._facility = CALENDAR_NAMES[CURRENT_CALENDAR];
  });

  const holidayEvents = await fetchEvents(HOLIDAY_CALENDAR_ID, year, month);
  const holidayMap = createHolidayMap(holidayEvents);

  container.innerHTML = "";
  container.appendChild(
    renderTable(
      events,
      holidayMap,
      year,
      month,
      CALENDAR_NAMES[CURRENT_CALENDAR],
      CALENDAR_COLORS[CURRENT_CALENDAR]
    )
  );

  updatePrintHeader();
}

/* æœˆã‚¿ãƒ–ç”Ÿæˆï¼ˆçµ±åˆç‰ˆï¼‰ */
const months = [];
for (let i = -1; i <= 12; i++) {
  const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
  months.push({ label: `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`, year: d.getFullYear(), month: d.getMonth() });
}
const tabArea = document.getElementById("monthTabs");
months.forEach((m, idx) => {
  const tab = document.createElement("div");
  tab.className = "tab" + (idx === 1 ? " active" : "");
  tab.dataset.year = m.year;
  tab.dataset.month = m.month;
  tab.textContent = m.label;

  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    loadMonth(m.year, m.month);
    updatePrintHeader();
  });

  tabArea.appendChild(tab);
});

/* æ–½è¨­ãƒœã‚¿ãƒ³ */
document.querySelectorAll(".calendar-buttons button").forEach(btn => {
  btn.addEventListener("click", () => {
    const cal = btn.dataset.cal;
    CURRENT_CALENDAR = cal === "all" ? "all" : Number(cal);

    document.querySelectorAll(".calendar-buttons button")
      .forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.documentElement.style.setProperty(
      "--color-primary",
      CALENDAR_COLORS[CURRENT_CALENDAR]
    );

    document.body.classList.remove("bg-gym", "bg-kouminkan", "bg-bekkan", "bg-all");
    if (cal === "1") document.body.classList.add("bg-kouminkan");
    if (cal === "2") document.body.classList.add("bg-gym");
    if (cal === "3") document.body.classList.add("bg-bekkan");
    if (cal === "all") document.body.classList.add("bg-all");

    const activeTab = document.querySelector("#monthTabs .active");
    loadMonth(Number(activeTab.dataset.year), Number(activeTab.dataset.month));
    updatePrintHeader();
  });
});

/* æ™‚é–“å¤‰æ› */
function toAmPm(timeRange, isAllDay = false) {
  if (isAllDay) return "çµ‚æ—¥";

  if (!timeRange.includes("â€“")) {
    const startObj = parseTime(timeRange);
    return `${startObj.label}ã€œ`;
  }

  const [start, end] = timeRange.split("â€“");
  const startObj = parseTime(start);
  const endObj   = parseTime(end);

  const crossesNoon =
    (startObj.period === "åˆå‰" && endObj.period === "åˆå¾Œ") ||
    (startObj.isNoon && !endObj.isNoon);

  const startStr = startObj.label;
  const endStr = crossesNoon ? endObj.label : endObj.labelNoPeriod;

  return `${startStr}ã€œ${endStr}`;

  function parseTime(t) {
    const [h, m] = t.split(":").map(Number);

    if (h === 12 && m === 0) {
      return {
        period: "",
        hour: "",
        min: "",
        isNoon: true,
        label: "æ­£åˆ",
        labelNoPeriod: "æ­£åˆ"
      };
    }

    if (h === 12 && m > 0) {
      const min = m === 0 ? "" : `${m}åˆ†`;
      return {
        period: "åˆå¾Œ",
        hour: 0,
        min,
        isNoon: false,
        label: `åˆå¾Œ0æ™‚${min}`,
        labelNoPeriod: `0æ™‚${min}`
      };
    }

    const period = h < 12 ? "åˆå‰" : "åˆå¾Œ";
    const hour12 = h % 12 === 0 ? 12 : h % 12;
    const min = m === 0 ? "" : `${m}åˆ†`;

    return {
      period,
      hour: hour12,
      min,
      isNoon: false,
      label: `${period}${hour12}æ™‚${min}`,
      labelNoPeriod: `${hour12}æ™‚${min}`
    };
  }
}

/* ã‚¿ã‚¤ãƒˆãƒ«ã ã‘å–å¾— */
function getTitleOnly(el) {
  for (const node of el.childNodes) {
    if (node.nodeType === Node.TEXT_NODE) {
      return node.textContent.trim();
    }
  }
  return "(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)";
}

/* ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆ1æœ¬ã ã‘ï¼‰ */
document.addEventListener("click", function(e) {
  const eventEl = e.target.closest(".event");
  if (!eventEl) return;

  const titleEl = eventEl.querySelector(".event-title");
  const timeEl  = eventEl.querySelector(".event-time");
  const tooltip = eventEl.querySelector(".tooltip");

  const title = getTitleOnly(titleEl);

  /* â˜…â˜…â˜… æ—¥ä»˜ï¼‹æ›œæ—¥ã‚’ä½œã‚‹ï¼ˆã“ã“ã‚’è¿½åŠ ï¼‰ â˜…â˜…â˜… */
  const dateRaw = eventEl.dataset.date;   // loadMonth ã§ data-date ã‚’ä»˜ã‘ã¦ã„ã‚‹å‰æ
  let dateStr = "";
  if (dateRaw) {
    const d = new Date(dateRaw);
    const youbi = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
    dateStr = `${d.getMonth() + 1}/${d.getDate()}(${youbi[d.getDay()]})`;
  }

  /* â˜…â˜…â˜… æ™‚é–“ã‚’ä½œã‚‹ï¼ˆæ—¢å­˜ï¼‰ â˜…â˜…â˜… */
  let time = "(æ™‚é–“ãªã—)";
  if (timeEl) {
    const raw = timeEl.textContent.trim();
    const isAllDay = raw === "";
    const jpTime = toAmPm(raw, isAllDay);

    // â˜… æ—¥ä»˜ãŒå–å¾—ã§ããŸå ´åˆã¯ã€Œæ—¥ä»˜ï¼‹æ™‚é–“ã€ã«ã¾ã¨ã‚ã‚‹
    time = dateStr ? `${dateStr} ${jpTime}` : jpTime;
  }

  /* å ´æ‰€ */
  const placeRaw = eventEl.dataset.location || "";
  const place = placeRaw.trim() !== "" ? placeRaw : "(å ´æ‰€ãªã—)";

  /* èª¬æ˜ */
  let description = "(èª¬æ˜ãªã—)";
  if (tooltip) {
    const lines = [...tooltip.querySelectorAll(".tooltip-line")].map(el =>
      el.textContent.trim()
    );
    if (lines.length > 0) description = lines.join("<br>");
  }

  /* æ–½è¨­ã‚¯ãƒ©ã‚¹ï¼ˆk / t / bï¼‰ */
  const facilityClass =
    titleEl.classList.contains("facility-k") ? "k" :
    titleEl.classList.contains("facility-t") ? "t" :
    titleEl.classList.contains("facility-b") ? "b" : "";

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æ–½è¨­ã‚«ãƒ©ãƒ¼ã‚’åæ˜  */
  const modalContent = document.querySelector(".modal-content");
  modalContent.classList.remove("k", "t", "b");
  if (facilityClass) modalContent.classList.add(facilityClass);

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å®¹ */
  const html = `
    <h3>${title}</h3>

    <div class="modal-info-box">
      <div class="modal-info-title">æ—¥æ™‚</div>
      <div>${time}</div>
    </div>

    <div class="modal-info-box">
      <div class="modal-info-title">å ´æ‰€</div>
      <div>${place}</div>
    </div>

    <div class="modal-info-box">
      <div class="modal-info-title">èª¬æ˜</div>
      <div>${description}</div>
    </div>
  `;

  document.getElementById("modal-body").innerHTML = html;
  document.getElementById("popup").style.display = "block";
});
/* èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ */
document.getElementById("popup").addEventListener("click", function(e) {
  if (e.target === this) closePopup();
});

document.getElementById("reload-btn").addEventListener("click", () => {
  const activeTab = document.querySelector("#monthTabs .active");
  const year = Number(activeTab.dataset.year);
  const month = Number(activeTab.dataset.month);

  loadMonth(year, month);
});

function closePopup() {
  document.getElementById("popup").style.display = "none";
}

/* åˆæœŸè¡¨ç¤º */
(function init() {
  document.body.classList.add("bg-kouminkan");
  const activeTab = document.querySelector("#monthTabs .active");
  if (activeTab) {
    loadMonth(Number(activeTab.dataset.year), Number(activeTab.dataset.month));
  } else {
    loadMonth(today.getFullYear(), today.getMonth());
  }
  updatePrintHeader();
})();
</script>
</body>
</html>

