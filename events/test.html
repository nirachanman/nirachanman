<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>川口コミュニティセンター 利用予定表</title>

  <style>
    body {
      font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", sans-serif;
      margin: 10px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

#title {
  font-size: 20px;      /* ← 好きなサイズに調整可能（例：18px でもOK） */
  margin-top: 2px;      /* 上の余白を縮める */
  margin-bottom: 2px;   /* 下の余白を縮める */
  line-height: 1.2;     /* 行間を少し詰める */
  text-align: center;   /* 中央揃え（必要なら） */
}

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      vertical-align: top;
      font-size: 14px;
      white-space: pre-wrap;
    }

    th {
      background-color: #f0f0f0;
      text-align: center;
    }

    @media print {
      body { margin: 0 }
      table { page-break-inside: avoid }
    }

.cooking {
  background-color: #fff7e6;
}

.nihonma {
  background-color: #f0f8ff;
}

.meeting {
  background-color: #f5f5f5;
}

.bikou {
  background-color: #ffffff;
}

/* ★ イベント文字を小さくする */
td.cooking,
td.nihonma,
td.meeting {
  font-size: 12px !important;
  line-height: 1.3;
}

/* ★ 日付文字を小さくする（1列目） */
#calendar-body td:first-child {
  font-size: 18px !important;
  line-height: 1.3;
}

.holiday {
  background-color: #ffe5e5;
  color: #d40000;
}

.saturday {
  background-color: #e8f1ff;
  color: #0044cc;
}

.sunday {
  background-color: #ffe5e5;
  color: #d40000;
}

  </style>

  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1 id="title"></h1>
<div style="text-align:center; margin-bottom: 15px;">
  <select id="monthSelector"></select>
</div>

<table>
<thead>
  <tr>
    <th style="width:12%;">日付</th>
    <th style="width:26%;">1階 調理室</th>
    <th style="width:26%;">2階 日本間</th>
    <th style="width:26%;">2階 小会議室</th>
    <th style="width:10%;">備考欄</th>
  </tr>
</thead>
  <tbody id="calendar-body"></tbody>
</table>

<script>
/* -----------------------------
   Google API 初期化（GitHub Pages対応）
----------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  if (window.gapi) {
    gapi.load("client", initClient);
  } else {
    console.error("gapi が読み込まれていません");
  }
});

async function initClient() {
  await gapi.client.init({
    apiKey: "",
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]
  });

  // ★ セレクトボックス生成
  setupMonthSelector();

  // ★ 初期表示（今月）
  const today = new Date();
  buildCalendar(today.getFullYear(), today.getMonth() + 1);
}

/* -----------------------------
   Google Calendar API 取得
----------------------------- */
async function fetchEvents(calendarId, year, month) {
  const timeMin = new Date(year, month - 1, 1).toISOString();
  const timeMax = new Date(year, month, 0, 23, 59, 59).toISOString();

  const url =
    `https://fancy-cell-0698.yajirobe-einstein.workers.dev` +
    `?calendarId=${encodeURIComponent(calendarId)}` +
    `&timeMin=${timeMin}` +
    `&timeMax=${timeMax}`;

  const res = await fetch(url);
  const data = await res.json();

  return data.items || [];
}

/* -----------------------------
   日付・部屋ごとに分類
----------------------------- */
function formatDate(dateStr) {
  const d = new Date(dateStr);

  const youbi = ["日", "月", "火", "水", "木", "金", "土"];
  const w = youbi[d.getDay()];

  // ★ 年を表示しない
  return `${d.getMonth() + 1}月${d.getDate()}日（${w}）`;
}

function formatTime(obj) {
  if (!obj || !obj.dateTime) return "";
  const d = new Date(obj.dateTime);
  return `${d.getHours()}:${String(d.getMinutes()).padStart(2, "0")}`;
}

function isJapaneseHoliday(dateStr) {
  const holidays = {
    "2026-01-01": "元日",
    "2026-01-12": "成人の日",
    "2026-02-11": "建国記念の日",
    "2026-02-23": "天皇誕生日",
    "2026-03-20": "春分の日",
    "2026-04-29": "昭和の日",
    "2026-05-03": "憲法記念日",
    "2026-05-04": "みどりの日",
    "2026-05-05": "こどもの日",
    "2026-07-20": "海の日",
    "2026-08-11": "山の日",
    "2026-09-21": "敬老の日",
    "2026-09-22": "国民の休日",
    "2026-09-23": "秋分の日",
    "2026-10-12": "スポーツの日",
    "2026-11-03": "文化の日",
    "2026-11-23": "勤労感謝の日"
  };

  return holidays[dateStr] !== undefined;
}

/* -----------------------------
   安全な日付抽出（終日イベント対応）
----------------------------- */
function getEventDate(ev) {
  if (ev.start?.date) return ev.start.date;
  if (ev.start?.dateTime) return ev.start.dateTime.split("T")[0];
  return null;
}

/* -----------------------------
   キーワードで部屋を判定
   [調理室] [和室] [小会議室]
----------------------------- */
function detectRoom(ev) {
  const text = (ev.summary + " " + (ev.description || "")).toLowerCase();

  if (text.includes("[調理室]") || text.includes("調理室")) return "cooking";
  if (text.includes("[日本間]")   || text.includes("日本間"))   return "nihonma";
  if (text.includes("[小会議室]") || text.includes("小会議室")) return "meeting";

  return "unknown";
}

/* -----------------------------
   1つのカレンダーから分類
----------------------------- */
function classifyEvents(events) {
  const map = {};

  events.forEach(ev => {
    const date = getEventDate(ev);
    if (!date) return;

    if (!map[date]) {
      map[date] = { cooking: "", nihonma: "", meeting: "" };
    }

    const room = detectRoom(ev);
    const text = `${ev.summary} ${formatTime(ev.start)}～${formatTime(ev.end)}`;

    if (room === "cooking") map[date].cooking += text + "\n";
    if (room === "nihonma") map[date].nihonma += text + "\n";
    if (room === "meeting") map[date].meeting += text + "\n";
  });

  return map;
}

/* -----------------------------
   HTML に描画
----------------------------- */
function renderTable(data, year, month) {
  document.getElementById("title").textContent =
    `川口コミュニティセンター 利用予定表（${year}年${month}月）`;

  const tbody = document.getElementById("calendar-body");
  tbody.innerHTML = "";

  const dates = Object.keys(data).sort();

dates.forEach(dateStr => {
  const row = document.createElement("tr");

  const d = new Date(dateStr);
  const day = d.getDay();

  let dateClass = "";
  if (isJapaneseHoliday(dateStr)) {
    dateClass = "holiday";
  } else if (day === 0) {
    dateClass = "sunday";
  } else if (day === 6) {
    dateClass = "saturday";
  }

  row.innerHTML = `
    <td class="datecell ${dateClass}">${formatDate(dateStr)}</td>
<td class="cooking">${(data[dateStr].cooking || "").replace(/\n/g, "<br>")}</td>
<td class="nihonma">${(data[dateStr].nihonma || "").replace(/\n/g, "<br>")}</td>
<td class="meeting">${(data[dateStr].meeting || "").replace(/\n/g, "<br>")}</td>
    <td class="bikou"></td>
  `;

  tbody.appendChild(row);
});
}

/* -----------------------------
   メイン処理
----------------------------- */
async function buildCalendar(year, month) {
  console.log("buildCalendar が呼ばれました", year, month);

  // ★ 月末日を取得
  const lastDay = new Date(year, month, 0).getDate();

  // ★ 全日付を先に作る（ズレない方式）
  const data = {};
  for (let day = 1; day <= lastDay; day++) {
    const dateStr = `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
    data[dateStr] = { cooking: "", nihonma: "", meeting: "" };
  }

  // ★ Google カレンダーのイベントを取得
  const events = await fetchEvents(
    "31492fb4b39fef411514fef1378eaf68f176de53432052015b21a14223757e1d@group.calendar.google.com",
    year,
    month
  );

  console.log("取得イベント:", events);

  // ★ イベントを分類して data に上書き
  const classified = classifyEvents(events);

  for (const date in classified) {
    if (data[date]) {
      data[date] = classified[date];
    }
  }

  // ★ 全日付を描画
  renderTable(data, year, month);
}

function setupMonthSelector() {
  const selector = document.getElementById("monthSelector");
  selector.innerHTML = "";

  const today = new Date();
  const start = new Date(today.getFullYear(), today.getMonth() - 1, 1); // 前月
  const end = new Date(today.getFullYear(), today.getMonth() + 12, 1); // 12ヶ月先

  let cursor = new Date(start);

  while (cursor <= end) {
    const y = cursor.getFullYear();
    const m = cursor.getMonth() + 1;

    const option = document.createElement("option");
    option.value = `${y}-${m}`;
    option.textContent = `${y}年${m}月`;

    // 当月を初期選択
    if (y === today.getFullYear() && m === today.getMonth() + 1) {
      option.selected = true;
    }

    selector.appendChild(option);

    cursor.setMonth(cursor.getMonth() + 1);
  }

  // 選択されたらカレンダー更新
  selector.addEventListener("change", () => {
    const [year, month] = selector.value.split("-").map(Number);
    buildCalendar(year, month);
  });
}

</script>

</body>
</html>

